# E2E 테스트 실행 결과 보고서

## 📊 실행 요약

- **실행 시간**: 2025년 1월 14일
- **총 테스트 스위트**: 2개
- **실행 시간**: 13.067초
- **결과**: ❌ **실패** (2개 스위트 모두 실패)

## 📈 테스트 통계

| 항목            | 수량 | 상태  |
| --------------- | ---- | ----- |
| **전체 테스트** | 35개 | -     |
| **✅ 성공**     | 16개 | 45.7% |
| **❌ 실패**     | 19개 | 54.3% |
| **⏭️ 스킵**     | 0개  | 0%    |

## 🔴 주요 실패 원인 분석

### 1. **데이터베이스 중복 제약 조건 위반** (가장 심각)

```
Unique constraint failed on the fields: (`email`)
```

- **발생 위치**: `test-helper.ts:36` - `createSystemAdmin()`
- **원인**: 테스트 간 데이터베이스가 제대로 초기화되지 않아 이메일 중복 발생
- **영향**: 초기 데이터 시드 실패로 연쇄적인 테스트 실패 유발

### 2. **데이터 의존성 문제**

- `refreshToken`이 `undefined`로 남아있어 토큰 갱신 테스트 실패
- `company.id`, `member.id` 등이 `undefined`로 참조 오류 발생
- 이전 테스트의 실패로 인한 연쇄 실패

### 3. **입력 유효성 검증 오류**

```
이름은 한글, 영문, 공백만 사용할 수 있습니다
```

- 테스트 데이터가 입력 검증 규칙을 위반

### 4. **인증 실패**

- 로그인 시도 시 "이메일 또는 비밀번호가 일치하지 않습니다" 오류
- 사용자가 제대로 생성되지 않았거나 비밀번호가 일치하지 않음

---

## 📋 상세 테스트 결과

### 1. 회원가입 및 승인 플로우

#### 1-1. 시스템 관리자

| 테스트 케이스                           | 결과 | 실패 원인 |
| --------------------------------------- | ---- | --------- |
| 시스템 관리자가 사전 생성되어 있어야 함 | ✅   | -         |

#### 1-2. 회사 관리자 회원가입

| 테스트 케이스                                   | 결과 | 실패 원인 |
| ----------------------------------------------- | ---- | --------- |
| 회사 관리자가 회원가입할 수 있어야 함           | ✅   | -         |
| 회원가입 후 로그인 차단되어야 함 (PENDING 상태) | ✅   | -         |
| 시스템 관리자가 회사를 승인할 수 있어야 함      | ✅   | -         |
| 승인 후 회사 관리자가 로그인할 수 있어야 함     | ✅   | -         |

#### 1-3. 팀원 회원가입

| 테스트 케이스                              | 결과 | 실패 원인 |
| ------------------------------------------ | ---- | --------- |
| 팀원이 초대 코드로 회원가입할 수 있어야 함 | ✅   | -         |
| 팀원 승인 전에는 로그인이 불가능해야 함    | ✅   | -         |
| 회사 관리자가 팀원을 승인할 수 있어야 함   | ✅   | -         |
| 팀원 승인 후 로그인 가능해야 함            | ✅   | -         |

---

### 2. 로그인 및 토큰 관리 플로우

#### 2-1. 로그인

| 테스트 케이스                              | 결과 | 실패 원인 |
| ------------------------------------------ | ---- | --------- |
| 승인된 회사 관리자가 로그인할 수 있어야 함 | ✅   | -         |

#### 2-2. Token Refresh 플로우

| 테스트 케이스                                             | 결과 | 실패 원인                       |
| --------------------------------------------------------- | ---- | ------------------------------- |
| Refresh Token으로 새로운 Access Token을 받을 수 있어야 함 | ❌   | refreshToken이 undefined        |
| 이미 사용된 Refresh Token은 재사용할 수 없어야 함         | ❌   | 토큰 갱신 실패로 인한 연쇄 실패 |

#### 2-3. 로그아웃 플로우

| 테스트 케이스                      | 결과 | 실패 원인                    |
| ---------------------------------- | ---- | ---------------------------- |
| 로그아웃 시 토큰이 무효화되어야 함 | ❌   | 로그인 실패로 인한 연쇄 실패 |

---

### 3. 비밀번호 재설정 플로우

#### 3-1. 비밀번호 재설정 요청

| 테스트 케이스                                       | 결과 | 실패 원인 |
| --------------------------------------------------- | ---- | --------- |
| 등록된 이메일로 재설정 요청이 가능해야 함           | ✅   | -         |
| 등록되지 않은 이메일도 동일한 응답을 해야 함 (보안) | ✅   | -         |

#### 3-2. 비밀번호 재설정 실행

| 테스트 케이스                                    | 결과 | 실패 원인 |
| ------------------------------------------------ | ---- | --------- |
| 유효한 토큰으로 비밀번호를 재설정할 수 있어야 함 | ✅   | -         |
| 재설정 후 새 비밀번호로 로그인 가능해야 함       | ✅   | -         |
| 재설정 후 이전 비밀번호로는 로그인 불가능해야 함 | ✅   | -         |

---

### 4. 권한 검증 플로우

| 테스트 케이스                                        | 결과 | 실패 원인             |
| ---------------------------------------------------- | ---- | --------------------- |
| 시스템 관리자만 회사를 승인할 수 있어야 함           | ❌   | 초기 데이터 시드 실패 |
| 회사 관리자가 자신의 회사 팀원을 승인할 수 있어야 함 | ❌   | 초기 데이터 시드 실패 |
| 다른 회사의 팀원은 승인할 수 없어야 함               | ❌   | 초기 데이터 시드 실패 |

---

### 5. 입력 검증 테스트

| 테스트 케이스                               | 결과 | 실패 원인   |
| ------------------------------------------- | ---- | ----------- |
| 이메일 형식이 올바르지 않으면 회원가입 실패 | ✅   | -           |
| 비밀번호가 8자 미만이면 회원가입 실패       | ❌   | 테스트 실패 |
| 중복된 이메일로 회원가입 불가               | ❌   | 테스트 실패 |
| 중복된 회사명으로 회원가입 불가             | ❌   | 테스트 실패 |

---

### 6. Login/Password Flow Tests (auth.login-flow.e2e.test.ts)

| 테스트 케이스                     | 결과 | 실패 원인                              |
| --------------------------------- | ---- | -------------------------------------- |
| 시스템 관리자 로그인 성공         | ❌   | 401 Unauthorized                       |
| 회사 관리자 회원가입 (PENDING)    | ❌   | 이름은 한글, 영문, 공백만 사용 가능    |
| 시스템 관리자의 회사 승인         | ❌   | Cannot read property 'id' of undefined |
| 회사 관리자 로그인 성공           | ❌   | 이메일 또는 비밀번호가 일치하지 않음   |
| 초대 코드로 팀원 회원가입         | ❌   | 토큰이 유효하지 않음                   |
| Refresh 토큰으로 Access 토큰 갱신 | ❌   | 401 Unauthorized                       |
| 로그아웃 및 쿠키 제거             | ❌   | 401 Unauthorized                       |
| 비밀번호 재설정 토큰 저장         | ❌   | Cannot read property 'id' of undefined |
| 비밀번호 재설정 성공              | ❌   | 400 Bad Request                        |

---

## 🎯 테스트 실행 순서 분석

### 현재 실행 구조

```
Auth API E2E Tests
├── 1. 회원가입 및 승인 플로우 (직렬 실행)
│   ├── 1-1. 시스템 관리자 검증
│   ├── 1-2. 회사 관리자 회원가입 → 시스템 관리자 승인
│   ├── 1-3. 팀원 회원가입 → 회사 관리자 승인
│   └── 1-4. 초기 데이터 시드
├── 2. 로그인 및 토큰 관리 플로우 (직렬 실행)
│   ├── 2-1. 회원가입과 승인 후 로그인
│   ├── 2-2. Token Refresh 플로우
│   └── 2-3. 로그아웃 플로우
├── 3. 비밀번호 재설정 플로우
├── 4. 권한 검증 플로우
└── 5. 입력 검증 테스트
```

- **1-1 ~ 1-4**: 순차적(직렬) 실행 - 데이터 의존성 있음
- **2-1 ~ 2-3**: 순차적(직렬) 실행 - refreshToken 공유
- **1번 블록 → 2번 블록**: 순차적(직렬) 실행 - 1번에서 생성한 사용자 데이터를 2번에서 사용

---

## 🔍 두 번째 테스트 파일 실패 원인 분석 (auth.login-flow.e2e.test.ts)

| 테스트 케이스                     | 결과 | 실패 원인                              |
| --------------------------------- | ---- | -------------------------------------- |
| 시스템 관리자 로그인 성공         | ❌   | 401 Unauthorized                       |
| 회사 관리자 회원가입 (PENDING)    | ❌   | 이름은 한글, 영문, 공백만 사용 가능    |
| 시스템 관리자의 회사 승인         | ❌   | Cannot read property 'id' of undefined |
| 회사 관리자 로그인 성공           | ❌   | 이메일 또는 비밀번호가 일치하지 않음   |
| 초대 코드로 팀원 회원가입         | ❌   | 토큰이 유효하지 않음                   |
| Refresh 토큰으로 Access 토큰 갱신 | ❌   | 401 Unauthorized                       |
| 로그아웃 및 쿠키 제거             | ❌   | 401 Unauthorized                       |
| 비밀번호 재설정 토큰 저장         | ❌   | Cannot read property 'id' of undefined |
| 비밀번호 재설정 성공              | ❌   | 400 Bad Request                        |

---

## 🔧 해결 방안

### 1. **즉시 수정 필요** (Critical)

```typescript
// test-helper.ts의 cleanDatabase() 메서드 개선
async cleanDatabase() {
  // 트랜잭션으로 모든 테이블 초기화
  await this.prisma.$transaction([
    this.prisma.refreshToken.deleteMany(),
    this.prisma.user.deleteMany(),
    this.prisma.company.deleteMany(),
    // ... 기타 테이블
  ]);
}
```

### 2. **테스트 격리 보장**

```typescript
beforeEach(async () => {
  await testHelper.cleanDatabase();
});

afterEach(async () => {
  await testHelper.cleanDatabase();
});
```

### 3. **테스트 데이터 검증**

```typescript
// 테스트 데이터 생성 시 검증 추가
const testData = {
  user_name: '테스트관리자', // 한글, 영문, 공백만 허용
  email: `test_${Date.now()}@example.com`, // 유니크 보장
};
```

### 4. **의존성 체크 추가**

```typescript
// 다음 테스트 진행 전 필수 데이터 확인
expect(refreshToken).toBeDefined();
expect(company.id).toBeDefined();
```

## 📋 권장 조치 사항

### 우선순위 1 (즉시)

1. ✅ `cleanDatabase()` 메서드 수정하여 완전한 초기화 보장
2. ✅ 테스트 간 격리 강화 (`beforeEach`/`afterEach` 추가)
3. ✅ 중복 이메일 방지를 위한 타임스탬프 추가

### 우선순위 2 (단기)

1. 테스트 데이터 유효성 검증 로직 추가
2. 실패 시 더 명확한 에러 메시지 제공
3. 테스트 의존성 체인 최소화

### 우선순위 3 (장기)

1. 테스트 병렬 실행 가능하도록 리팩토링
2. 테스트 데이터 팩토리 패턴 도입
3. E2E 테스트와 통합 테스트 분리

---

## 📌 참고 사항

- 테스트는 `--runInBand` 옵션으로 순차 실행 중
- `ts-jest` 설정 경고 있음 (`isolatedModules` 옵션 마이그레이션 필요)
- 테스트 환경: `.env.test` 파일 사용
- 두 번째 테스트 파일(`auth.login-flow.e2e.test.ts`)도 동일한 문제로 실패

---

_보고서 생성: 2025년 1월 14일_
_테스트 환경: Jest 29.7 + TypeScript + Prisma_
